
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Android How To Documentation - Smart Campus</title>
  <meta name="author" content="Smart Campus">

  
  <meta name="description" content="Android How to Documentation This document aims at describing the main elements necessary for development of a new SmartCampus Android app and its &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://smartcampuslab.github.io/android">
  <link href="/favicon.png" rel="icon">
  <link href='http://fonts.googleapis.com/css?family=Quicksand' rel='stylesheet' type='text/css'>
  <link href="/stylesheets/bootstrap.css" rel="stylesheet">
  <link href="/stylesheets/bootstrap-responsive.css" rel="stylesheet">
  <link href="/stylesheets/flat-ui.css" rel="stylesheet">
  <link href="/atom.xml" rel="alternate" title="Smart Campus" type="application/atom+xml">
  <script src="/js/jquery.js"></script>
  <script src="/js/bootstrap-collapse.js"></script>
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="./javascripts/lib/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-35617863-3']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body   >
  <div class="navbar navbar-inverse navbar-static-top">
  	<div class="navbar-inner">
  	  <div class="container">
        <a class="btn btn-navbar" data-toggle="collapse" data-target=".navbar-responsive-collapse">
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
        </a>
  	  	<div class="nav-collapse collapse navbar-responsive-collapse" style="height:0;">
  	      <ul class="nav">
    <li><a href="/">Approach</a></li>
    <li><a href="/architecture">Architecture</a></li>
    <li><a href="/android">Android How To</a></li>
</ul>

  	    </div>
  	  </div>
  	</div>
  </div>
  <div class="container" id="main">
    <div class="span12">
      <div class="row-fluid">
        <div id="content">
          <article role="article">
  
  <header>
    <div class="jumbotron">
      Android How to Documentation
    </div>
    
  </header>
  
  <p>This document aims at describing the main elements necessary for development of a new SmartCampus Android app and its integration with the existing apps and app container. Starting from the overall architecture, it explains the mechanisms for the authentication, interactions with remote services, as well as the support libraries for data storage/synchronization and for the common tasks.</p>

<h2>Architecture</h2>

<p>The SmartCampus Android applications are not totally independent. They rely upon presence of the “container” application that:</p>

<ul>
<li>provides the dashboard, from which one can access the apps;</li>
<li>allows for managing the application updates;</li>
<li>provides the SmartCampus user authentication that is essential for accessing the SmartCampus platform and the Web services;</li>
</ul>


<p>Note that in order to restrict the access only to the apps that make part of the SmartCampus apps ecosystem and to protect the sensitive resources (e.g., use credentials), the container poses some restrictions on the app declaration, deployment, and execution. Specifically, the applications should have the same sharedUserId and be signed with the same certificate. Furthermore, some of the exported elements (activities and services) are additionally protected with the corresponding “signature”-protected permissions.</p>

<p>Development note: in these settings the applications developed and tested locally may be in conflict with the “official” apps already installed. For this reason, the old apps should be uninstalled and installed from the development environment with the same debug certificate.</p>

<p>You can find <a href="/architecture/SmartCampus_platform_architecture.pdf" title="">here</a> a document describing in detail the architecture of the SmartCampus platform.</p>

<h2>Application Configuration</h2>

<p>A SmartCampus application should adhere to the following configuration constraints and requirements:</p>

<ul>
<li>define the following shared user id and the label in AndroidManifest.xml:</li>
</ul>


<pre style="font-size: 18px">
    android:sharedUserId="eu.trentorise.smartcampus.shared"
    android:sharedUserLabel="SmartCampus"
</pre>


<p></p>

<ul>
<li><p>declare references to the corresponding libraries in the project configuration. For example, for Eclipse IDE the libraries are declared in Project Properties/Android section. The dependencies may include, in particular:</p>

<ul>
<li>authentication support library (android.security.client)</li>
<li>storage support (android.storage)</li>
<li>common utility library (smartcampus.android.common)</li>
<li>communication protocol support library (protocol-carrier)</li>
</ul>


<p><img src="/android/eclipse.png" title="Eclipse" alt="screen" /></p>

<p>Development note: in order to make the library available to the project it is necessary to add them to the Eclipse workspace as library projects. The library sources are available at https://github.com/smartcampuslab</p></li>
<li><p>Define the target Android SDK version constraints in AndroidManifest.xml. The minimal library should be:</p></li>
</ul>


<pre style="font-size: 18px">
    <uses-sdk android:minSdkVersion="8" ... />
</pre>


<h2>Authentication</h2>

<p>The access to the remote SmartCampus services requires the requests to be accompanied with the user authentication token. The token is emitted, renewed, and invalidated via the Acess Control service. The actual authentication is delegated to the external identity managers so that the user credentials are not available to the apps. Currently, the authentication relies on the Shibboleth protocol.</p>

<p>On the client side, the authentication and token management is performed using the android.security.client library. The library is used to acquire, store, and retrieve the user access tokens. The library uses Android Account API, which natively handles creation and update of the accounts and access tokens.</p>

<p>To acquire the authentication token to use when calling remote service, the following steps are necessary:</p>

<ol>
<li><h4>get the reference to the SCAccessProvider:</h4>

<p> SCAccessProvider accessProvider = new AMSCAccessProvider();</p></li>
<li><h4>Acquire the token using one of the methods exposed by the access provider:</h4>

<ul>
<li><p>getAuthToken(Activity activity, String authority): retrieve access token from the running activity. If the token is stored locally, it is returned, otherwise a dedicated Authentication activity starts for result. The
calling activity should implement the Activity.onActivityResult method to process the obtained token. The authority attributes defines the required authentication authority. If not specified, the user can login with any authority.</p></li>
<li><p>getAuthToken(Context ctx, String authority, IntentSender intentSender): Retrieve the authentication token from the an arbitrary context. If the token is stored locally, it is returned, otherwise a notification is added to the notification bar. If the user accesses the notification, the Authentication Activity starts and publishes the corresponding authentication result broadcast if successful. In case of implementation based on AccountManager infrastructure (eu.trentorise.smartcampus.ac.authenticator.AMSCAccessProvider), the broadcast with action AccountManager.LOGIN_ACCOUNTS_CHANGED_ACTION is propagated. In case of implementation based on local storage(eu.trentorise.smartcampus.ac.embedded. EmbeddedSCAccessProvider), a broadcast with action eu.trentorise.smartcampus.account.AUTHTOKEN_CHANGED is sent.</p></li>
<li><p>getAuthToken(Context ctx, String authority): Retrieve the authentication token from the an arbitrary context. If the token is stored locally, it is returned, otherwise the Authentication Activity starts, which, upon successful completion sends the specified intent.</p></li>
<li><p>readToken(Context ctx, String authority): Read token from the local cache without additional requests if the token is missing.</p></li>
</ul>
</li>
<li><h4>If the token is requested from an activity, implement the Activity.onActivityResult method to process the obtained token.</h4></li>
<li><h4>Declare the necessary permissions in AndroidManifest.xml:</h4></li>
</ol>


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>&lt;uses-permission android:name="android.permission.GET_ACCOUNTS"/&gt;</span></code></pre></td></tr></table></div></figure>


<h2>Data Storage</h2>

<p>The android.storage library provides an abstraction layer for Android to perform principal data management operations given the Java Beans object model. The main case studies covered by the library refer to</p>

<ul>
<li>store the application data objects locally in database;</li>
<li>store the application data remotely on the server;</li>
<li>support continuous incremental data synchronization with remote services.</li>
</ul>


<p>The abstraction relies upon CRUD (create/read/update/delete) operations, providing the necessary extensions for each of the case studies. In this way, the switch from, e.g., remote storage to the local one is simplified as the object model and the core interfaces are equal.</p>

<h3>Remote Storage</h3>

<p>To use the library for the remote storage, the following steps are necessary:</p>

<ol>
<li><p>Define the data model of the objects. The required data model has to be defined as Java Beans that inherit from eu.trentorise.smartcampus.storage.BasicObject. Note that the the client-side java classes should have the same signature as their remote counterparts used to populate the REST/JSON objects. This is required for the correct data transformation on the client side.</p></li>
<li><p>Instantiate the eu.trentorise.smartcampus.storage.remote.RemoteStorage class passing the Context, appToken, authToken, host (remote host and port), and service (name of the remote API application prefix).</p></li>
<li><p>Call the corresponding method of the storage class. See the javadoc for the eu.trentorise.smartcampus.storage.remote.IRemoteStorage interface for details.</p></li>
</ol>


<p>The remote counterpart is expected to expose the REST interfaces with the following signature conventions:</p>

<ul>
<li><p>for object creation: POST <host>/<service>/<canonical-name-of-object-java-class>. The passed JSON represents the instance of the corresponding Java bean class.</p></li>
<li><p>for object update: PUT <host>/<service>/<canonical-name-of-object-java-class>/<id>. The passed JSON represents the instance of the corresponding Java bean class to be updated. The id is the value of the id field of the updated object.</p></li>
<li><p>for object delete: DELETE <host>/<service>/<canonical-name-of-object-java-class>/<id>. No request body is passed. The id is the value of the id field of the deleted object.</p></li>
<li><p>for individual object access by ID: GET <host>/<service>/<canonical-name-of-object-java-class>/<id>. No request body is passed. The id is the value of the id field of the deleted object. Should return the JSON representation of the object of the specified class and with the specified id.</p></li>
<li><p>for object access by type: GET <host>/<service>/<canonical-name-of-object-java-class>. No request body is passed. Should return the JSON array representation of the objects of the specified class.</p></li>
<li><p>for object search: GET <host>/<service>/objects. Query object is passed as &#8220;filter&#8221; query parameters in JSON representation. Should return the JSON map with full java class names as the keys and the corresponding array of the objects of those classes matching the criteria.</p></li>
<li><p>for batch update: POST <host>/<service>/objects. Passes the JSON representation of the eu.trentorise.smartcampus.storage.remote.BatchData class describing the update. The class contains &#8220;created&#8221; map of the objects to be created (full java class name as a key and list of objects as value), &#8220;updated&#8221; map of the objects to be updated (full java class name as a key and list of objects as value), and &#8220;deleted&#8221; map of the objects to be deleted (full java class name as a key and list of objectIds as value).</p></li>
</ul>


<h3>Local storage</h3>

<p>The implementation of the local Android storage is based on the SQLite database. This requires the mapping between the app object model and the table model of the underlying DB. The following steps are required in order to realize the local storage:</p>

<ol>
<li><p>Define the data model to be stored, i.e., te objects to be saved. The required data model has to be defined as Java Beans that inherit from eu.trentorise.smartcampus.storage.BasicObject.</p></li>
<li><p>Define the storage configuration. To do this it is necessary to:</p>

<ol>
<li><p>implement the eu.trentorise.smartcampus.storage.db.StorageConfiguration interface. Specifically, define which Java Bean classes are stored in sync storage (method getClasses), what the name of the DB table for each bean to use (method getTableName), and which storage helper to use for each of the bean types.</p></li>
<li><p>For each of the stored types implement the eu.trentorise.smartcampus.storage.db.BeanStorageHelper interface. Specifically, define the conversion of the data cursor row to the bean (method toBean), conversion of the bean to DB content (method toContent) and describe the object-specific column format (i.e., type and metadata in the SQLite format, method getColumnDefinitions).</p></li>
</ol>
</li>
<li><p>Instantiate the eu.trentorise.smartcampus.storage.sync.SyncStorage class passing the Context, appToken, database name and version, and the storage configuration.</p></li>
<li><p>Manipulate the data of the storage using the corresponding methods.</p></li>
</ol>


<h3>Data synchronization support</h3>

<p>The storage library supports data synchronization with the remote services. Specifically, the any of the stored object is versioned and the current DB object version is exploited in order to implement the incremental data synchronization: only the changed/new/deleted data is being transferred to/from the services. To perform the synchronization the SyncStorage class provides the implementation of the synchronize method, given the user authentication token, remote host, and service data.</p>

<p>The possible implementations of the scheduled data synchronization is described in Data Synchronization section.</p>

<h2>Communication with SmartCampus Services</h2>

<p>The client-server protocol defines the communication instructions between the application client (e.g., Android or Web Browser client) and the exposed VAS services and APIs. The generic model of the protocol structured as in the following figure.</p>

</article>

</div>


        </div>
      </div>
      <div class="row-fluid">
        <footer role="contentinfo">
          


        </footer>
      </div>
    </div>
  </div>
  







  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = 'http://platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
